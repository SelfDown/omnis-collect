service:

  - key: start
    module: 'ssh'# 执行监控 查询
    must_login: false
    log: true
    extend_param: monitor.install
    shell:
      services:
        - key: start
          type: start
          name: 开始
          next: start_app
        - key: start_app
          name: 启动
          type: node
          shell: "cd {{'monitor_home'|get_key}}sbin && zabbix_agentd -c ../conf/zabbix_agentd.conf"
          next: end
          fail: end
        - key: end
          name: 结束
          type: end
  - key: stop
    module: 'ssh'# 执行监控 查询
    must_login: false
    log: true
    extend_param: monitor.install
    shell:
      services:
        - key: start
          type: start
          name: 开始
          next: stop
        - key: stop
          name: 停止进程
          type: node
          shell: " ps -ef|grep zabbix |grep -v grep && ps -ef|grep zabbix |grep -v grep|awk  '{print $2}'|xargs kill -9"
          next: end
          fail: end

        - key: end
          name: 结束
          type: end

  - key: agentd_uninstall
    module: 'ssh'# 执行监控 查询
    must_login: false
    log: true
    extend_param: monitor.agentd_install
    shell:
      services:
        - key: start
          type: start
          name: 开始
          next: stop
        - key: stop
          name: 停止进程
          type: node
          shell: "service {{monitor_service_file_name}} stop"
          next: remove
          ignore_error: true
          fail: end

        - key: remove
          name: 删除开机启动
          type: node
          shell: "chkconfig --del {{monitor_service_file_name}}"
          next: end
          ignore_error: true
          fail: end

        - key: end
          name: 结束
          type: end

  # 项目
  - key: "agentd_install"
    module: 'ssh'# 执行监控 查询
    must_login: false
    log: true
    params:
      server_ip:
        check:
          template: "{{server_ip|must}}"
          err_msg: 服务器IP 不能为空
      user:
        check:
          template: "{{user|must}}"
          err_msg: "用户不能为空"
      password:
        check:
          template: "{{password|must}}"
          err_msg: "【{{server_ip}}】 root 密码不能为空"
      port:
        default: 22
      timeout:
        default: 1

      collect_home:
        template: "{{'omnis_tmp'|get_key}}/zabbix_agent"
      upload_file:
        default: "omnis_collect_agents_3.2.0.linux2_6_23.amd64.tar.gz"
      monitor_home:
        template: "{{'monitor_home'|get_key}}"
      log_file:
        template: "{{'monitor_home'|get_key}}logs/zabbix_agentd.log"
      pid_file:
        template: "{{'monitor_home'|get_key}}/zabbix_agentd.pid"
      monitor_api_server:
        template: "{{'monitor_api_server'|get_key}}"
      monitor_host_name:
        template: "{{server_ip}}.{{'monitor_project_code'|get_key}}"
      template_file_from:
        template: "{{'omnis_tmp'|get_key}}/zabbix_template/zabbix_agentd.conf"
      template_file_to:
        template: "{{'omnis_tmp'|get_key}}/zabbix_target/{{'monitor_project_code'|get_key}}/{{server_ip}}/zabbix_agentd.conf"

      monitor_service_file_name:
        default: "monitor"
      service_template_file_from:
        template: "{{'omnis_tmp'|get_key}}/zabbix_template/{{monitor_service_file_name}}"
      service_template_file_to:
        template: "{{'omnis_tmp'|get_key}}/zabbix_target/{{'monitor_project_code'|get_key}}/{{server_ip}}/{{monitor_service_file_name}}"

      owner:
        default: "zabbix"
    shell:
      services:
        - key: start
          type: start
          name: 开始
          next: create_user
        - key: create_user
          type: node
          name: 创建用户
          shell: "cat /etc/passwd|grep {{owner}} || useradd -M -r -d /dev/null -s /sbin/nologin {{owner}}"
          next: upload
          fail: end
        - key: upload
          name: 上传文件
          type: node
          copy:
            from: "{{collect_home}}/{{upload_file}}"
            to: "{{monitor_home}}"
          save_field: 'upload_path'
          next: tar
          fail: end
        - key: tar
          name: 解压
          type: node
          shell: "cd {{monitor_home}} && tar -zxvf {{upload_path}}"
          next: create_log_home
          fail: end
        - key: create_log_home
          name: 创建日志
          type: node
          shell: "mkdir -p {{monitor_home}}logs && touch {{log_file}} "
          next: gen_template
          fail: end
        - key: gen_template
          name: 生成配置文件
          type: node
          gen_template:
            from: "{{template_file_from}}"
            to: "{{template_file_to}}"
          fail: end
          next: upload_config
        - key: upload_config
          name: 上传配置
          type: node
          copy:
            from: "{{template_file_to}}"
            to: "{{monitor_home}}conf/zabbix_agentd.conf"
          next: chown
          fail: end
        - key: chown
          name: 授权
          type: node
          shell: "chown -R {{owner}}.{{owner}} {{monitor_home}}"
          next: facl_zabbix
          fail: end
        - key: facl_zabbix
          name: 安全文件授权
          type: node
          shell: "setfacl -m u:{{owner}}:r--  /var/log/secure"
          next: gen_service_template
          fail: end
        - key: gen_service_template
          name: 生成服务文件
          type: node
          gen_template:
            from: "{{service_template_file_from}}"
            to: "{{service_template_file_to}}"
          next: upload_service_template
          fail: end
        - key: upload_service_template
          name: 上传开机启动脚本
          type: node
          copy:
            from: "{{service_template_file_to}}"
            to: "/etc/rc.d/init.d/"
          save_field: 'upload_chk_path'
          next: add_chk
          fail: end
        - key: add_chk
          name: 添加开机启动
          type: node
          shell: "chmod +x {{upload_chk_path}} && chkconfig --add {{monitor_service_file_name}} "
          next: start_monitor
          fail: end

        - key: start_monitor
          name: 启动监控服务
          type: node
          shell: "service {{monitor_service_file_name}} stop && service {{monitor_service_file_name}} start"
          next: end
          fail: end
        - key: end
          name: 结束
          type: end
    result_handler:
      - key: add_param
        params:
          from_field: 'upload_path'
          to_field: 'upload_path'
      - key: add_param
        params:
          from_field: 'log_file'
          to_field: 'log_file'
      - key: add_param
        params:
          from_field: 'template_file_to'
          to_field: 'template_file_to'

      - key: add_param
        params:
          from_field: 'upload_chk_path'
          to_field: 'upload_chk_path'


