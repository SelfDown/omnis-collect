service:

  - key: host_not_jmx_interface_query
    module: "monitor"
    params:
      hostid_list:
        check:
          template: "{{hostid_list|must_list}}"
          err_msg: "主机列表不能为空"
    data_json: host_interface_query.json
    log: true
    result_handler:
      - key: filter_arr
        params:
          field: interfaces
          template: "{{type=='4'}}"
      - key: arr2obj
        params:
          field: interfaces
      - key: value_arr
        params:
          template: "{% if not interfaces %}{{hostid}}{%  endif %}"


  # 项目
  - key: "host_query"
    module: 'monitor'# 执行监控 查询
    must_login: false
    params:
      server_ip:
        check:
          template: "{{server_ip|must}}"
          err_msg: "主机不能为空"
      host:
        template: "{{server_ip}}.{{'monitor_project_code'|get_key}}"
    data_json: host_query.json
    log: true
    result_handler:
      - key: arr2obj

  # 删除主机
  - key: "host_delete"
    module: 'monitor'# 执行监控 查询
    params:
      hostid:
        check:
          template: "{{hostid|must}}"
          err_msg: 主机不能为空
    must_login: false
    data_json: host_delete.json
    log: true
  # 删除模板
  - key: "host_unlink_template"
    module: 'monitor'# 执行监控 查询
    params:
      templateid_list:
        check:
          template: "{{templateid_list|must_list}}"
          err_msg: "请选择模板列表"
      hostid_list:
        check:
          template: "{{hostid_list|must_list}}"
          err_msg: "请选择主机"
    must_login: false
    data_json: host_unlink_template.json
    log: true

  # 创建主机
  - key: "host_create"
    module: 'monitor'# 执行监控 查询
    params:
      groupid:
        check:
          template: "{{groupid|must}}"
          err_msg: 分组不能为空

    extend_param: monitor.host_query
    must_login: false
    data_json: host_create.json
    log: true
    result_handler:
      - key: arr2obj
        params:
          field: hostids
      - key: new_col
        params:
          to_field:
            - field: hostid
              template: "{{hostids}}"
          remove:
            - hostids

  # 更新主机
  - key: "host_update"
    module: 'monitor'# 执行监控 查询
    params:
      groupid:
        check:
          template: "{{groupid|must}}"
          err_msg: 分组不能为空
      hostid:
        check:
          template: "{{hostid|must}}"
          err_msg: 监控主机不能为空
    extend_param: monitor.host_query
    must_login: false
    data_json: host_update.json
    log: true
    result_handler:
      - key: arr2obj
        params:
          field: hostids
      - key: new_col
        params:
          to_field:
            - field: hostid
              template: "{{hostids}}"
          remove:
            - hostids

  # 项目
  - key: "monitor_server_get"
    module: 'monitor'# 执行监控 查询
    must_login: false
    params:
      install_soft_id:
        name: "软件"
    handler_params:
      - key: service2field # 获取天览拨测主机
        enable: "{% if install_soft_id %}True{% endif %}"
        service:
          service: 'server.soft2server'
          install_soft_id: "install_soft_id"
        save_field: 'soft_server'
    data_json: monitor_server.json
    log: true

    result_handler:
      - key: arr2obj
        params:
          field: interfaces
      - key: arr2obj
      - key: new_col
        params:
          to_field:
            - field: 'interfaceid'
              template: "{{interfaces.interfaceid}}"
          remove:
            - interfaces


  - key: "host_id"
    module: 'service_flow'
    must_login: false
    log: true
    params:
      server_ip:
        check:
          template: "{{server_ip|must}}"
          err_msg: "主机不能为空"
      project_name:
        check:
          template: "{{project_name|must}}"
          err_msg: "主机项目名称不能为空"
      monitor_agent_id:
        template: "[{{project_name}}]-{{server_ip}}-[{{server_busi_name|safe}}]"
      monitor_agent_group:
        template: "{{'monitor_group_name'|get_key}}"
      is_windows:
        check:
          template: "{{is_windows|must}}"
          err_msg: "操作系统不能为空"

    extend_param: monitor.host_query
    flow:
      services:
        - key: start
          type: start
          name: 开始
          next: get_template

        - key: get_template
          type: node
          name: 获取获取模板
          service:
            service: 'monitor.get_omnis_template'
          save_field: 'template'
          fail: end
          next: get_host

        - key: get_host
          type: node
          name: 获取监控主机
          service:
            service: 'monitor.host_query'
            server_ip: server_ip
          save_field: 'host'
          next: "{%if host.hostid%}update_host{%else%}create_host{% endif %}"
          fail: end

        - key: create_host
          type: node
          name: 创建主机
          service:
            service: 'monitor.host_create'
            groupid: "{{group.groupid}}"
            templateid: "{{template.templateid}}"
          save_field: 'host'
          next: end
          fail: end


        - key: update_host
          type: node
          name: 修改主机
          service:
            service: 'monitor.host_update'
            hostid: "{{host.hostid}}"
            groupid: "{{group.groupid}}"
            templateid: "{{template.templateid}}"
          next: end
          fail: end

        - key: end
          type: end
          name: 结束
    result_handler:
      - key: add_param
        params:
          from_field: host
          to_field: host
      - key: add_param
        params:
          from_field: monitor_agent_group
          to_field: monitor_agent_group
      - key: add_param
        params:
          from_field: monitor_agent_id
          to_field: monitor_agent_id
      - key: new_col
        params:
          to_field:
            - field: "hostid"
              template: "{{host.hostid}}"
          remove:
            - host





